--[[

 ██████╗ ██╗  ██╗       ██╗   ██╗██╗   ██╗██╗    ██╗
██╔═══██╗╚██╗██╔╝       ██║   ██║██║   ██║██║    ██║
██║██╗██║ ╚███╔╝        ██║   ██║██║   ██║██║ █╗ ██║
██║██║██║ ██╔██╗        ╚██╗ ██╔╝╚██╗ ██╔╝██║███╗██║
╚█║████╔╝██╔╝ ██╗███████╗╚████╔╝  ╚████╔╝ ╚███╔███╔╝
 ╚╝╚═══╝ ╚═╝  ╚═╝╚══════╝ ╚═══╝    ╚═══╝   ╚══╝╚══╝ 

]]--

-- lynkUI v2.0 - Professional Script Hub UI Library
-- Author: Enhanced by Claude for universal script hub
-- Features: Modern design, smooth animations, player profile, search functionality
-- Four main tabs: Home (Script Hub), Updates, Credits, Settings

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")

local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    error("lynkUI: LocalPlayer not found - run as a LocalScript / exploit local")
end

-- Enhanced Utilities
local function new(class, props)
    local inst = Instance.new(class)
    if type(props) == "table" then
        for k,v in pairs(props) do
            pcall(function() inst[k] = v end)
        end
    end
    return inst
end

local function createGradient(parent, colors, rotation)
    local gradient = new("UIGradient", {
        Color = ColorSequence.new(colors),
        Rotation = rotation or 0
    })
    gradient.Parent = parent
    return gradient
end

local function createGlow(parent, color, size)
    local glow = new("ImageLabel", {
        Name = "Glow",
        Parent = parent,
        BackgroundTransparency = 1,
        Image = "rbxasset://textures/ui/Glow.png",
        ImageColor3 = color or Color3.new(1,1,1),
        ImageTransparency = 0.8,
        Size = size or UDim2.new(1, 20, 1, 20),
        Position = UDim2.new(0, -10, 0, -10),
        ZIndex = parent.ZIndex - 1
    })
    return glow
end

-- Professional Color Palette
local THEME = {
    WindowSize = UDim2.new(0, 880, 0, 560),
    
    -- Dark theme colors
    Background = Color3.fromRGB(11, 11, 13),
    Surface = Color3.fromRGB(15, 15, 17),
    Panel = Color3.fromRGB(19, 19, 22),
    Card = Color3.fromRGB(23, 23, 27),
    
    -- Accent colors
    Primary = Color3.fromRGB(88, 101, 242),    -- Discord-like purple
    Secondary = Color3.fromRGB(114, 137, 218), -- Lighter purple
    Success = Color3.fromRGB(67, 181, 129),    -- Green
    Warning = Color3.fromRGB(250, 166, 26),    -- Orange
    Danger = Color3.fromRGB(237, 66, 69),      -- Red
    
    -- Text colors
    Text = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(185, 187, 190),
    TextMuted = Color3.fromRGB(114, 118, 125),
    
    -- Border and dividers
    Border = Color3.fromRGB(35, 35, 40),
    Divider = Color3.fromRGB(45, 45, 50),
    
    -- Corner radius
    CornerRadius = UDim.new(0, 12),
    SmallCornerRadius = UDim.new(0, 8),
    
    -- Animation settings
    FastTween = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    MediumTween = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    SlowTween = TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
}

-- Added key system variables and functions
local KEY_SYSTEM_ENABLED = true
local VALID_KEY = "4tB8vW1pR6sY9Jq"
local KEY_LINK = "https://sub2unlock.io/3HTi5"

-- Global notification system
local NotificationSystem = {}
NotificationSystem.notifications = {}
NotificationSystem.isActive = false

function NotificationSystem:CreateNotification(title, message, notificationType, duration)
    if not self.isActive then return end
    
    duration = duration or 4
    notificationType = notificationType or "info"
    
    -- Create notification container
    local notification = new("Frame", {
        Name = "Notification",
        Size = UDim2.new(0, 300, 0, 80),
        Position = UDim2.new(1, 320, 0, 20 + (#self.notifications * 90)),
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        ZIndex = 1000
    })
    
    -- Parent to CoreGui for maximum override
    local notifGui = new("ScreenGui", {
        Name = "LynkNotification",
        Parent = game:GetService("CoreGui"),
        DisplayOrder = 999999998,
        IgnoreGuiInset = true,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    notification.Parent = notifGui
    
    local corner = new("UICorner")
    corner.CornerRadius = THEME.SmallCornerRadius
    corner.Parent = notification
    
    -- Notification icon
    local icon = new("TextLabel", {
        Position = UDim2.new(0, 15, 0, 15),
        Size = UDim2.new(0, 30, 0, 30),
        BackgroundTransparency = 1,
        Text = notificationType == "success" and "✓" or notificationType == "error" and "✗" or "ℹ",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        TextColor3 = notificationType == "success" and THEME.Success or notificationType == "error" and THEME.Danger or THEME.Primary,
        TextXAlignment = Enum.TextXAlignment.Center,
        TextYAlignment = Enum.TextYAlignment.Center,
        ZIndex = 1001
    })
    icon.Parent = notification
    
    -- Title
    local titleLabel = new("TextLabel", {
        Position = UDim2.new(0, 55, 0, 10),
        Size = UDim2.new(1, -70, 0, 20),
        BackgroundTransparency = 1,
        Text = title,
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 1001
    })
    titleLabel.Parent = notification
    
    -- Message
    local messageLabel = new("TextLabel", {
        Position = UDim2.new(0, 55, 0, 35),
        Size = UDim2.new(1, -70, 0, 35),
        BackgroundTransparency = 1,
        Text = message,
        Font = Enum.Font.Gotham,
        TextSize = 12,
        TextColor3 = THEME.TextSecondary,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true,
        ZIndex = 1001
    })
    messageLabel.Parent = notification
    
    -- Add to notifications list
    table.insert(self.notifications, {gui = notifGui, frame = notification})
    
    -- Slide in animation
    TweenService:Create(notification, THEME.MediumTween, {
        Position = UDim2.new(1, -320, 0, 20 + ((#self.notifications - 1) * 90))
    }):Play()
    
    -- Play notification sound
    spawn(function()
        pcall(function()
            local sound = new("Sound", {
                SoundId = "rbxasset://sounds/electronicpingshort.wav",
                Volume = 0.5,
                Parent = SoundService
            })
            sound:Play()
            sound.Ended:Connect(function()
                sound:Destroy()
            end)
        end)
    end)
    
    -- Auto dismiss with fallback
    spawn(function()
        wait(duration)
        self:DismissNotification(notifGui)
    end)
    
    -- Fallback cleanup in case notification gets stuck
    spawn(function()
        wait(duration + 2)
        if notifGui and notifGui.Parent then
            pcall(function()
                notifGui:Destroy()
            end)
        end
    end)
end

function NotificationSystem:DismissNotification(notifGui)
    if not notifGui or not notifGui.Parent then return end
    
    local notification = notifGui:FindFirstChild("Notification")
    if notification then
        -- Slide out animation
        TweenService:Create(notification, THEME.FastTween, {
            Position = UDim2.new(1, 320, notification.Position.Y.Scale, notification.Position.Y.Offset)
        }):Play()
        
        wait(0.2)
    end
    
    -- Remove from list and destroy
    for i, notif in ipairs(self.notifications) do
        if notif.gui == notifGui then
            table.remove(self.notifications, i)
            break
        end
    end
    
    pcall(function()
        notifGui:Destroy()
    end)
    
    -- Reposition remaining notifications
    for i, notif in ipairs(self.notifications) do
        if notif.frame and notif.frame.Parent then
            TweenService:Create(notif.frame, THEME.FastTween, {
                Position = UDim2.new(1, -320, 0, 20 + ((i - 1) * 90))
            }):Play()
        end
    end
end

function NotificationSystem:Initialize()
    self.isActive = true
end

function NotificationSystem:Cleanup()
    self.isActive = false
    for _, notif in ipairs(self.notifications) do
        if notif.gui and notif.gui.Parent then
            pcall(function()
                notif.gui:Destroy()
            end)
        end
    end
    self.notifications = {}
end

local function createKeySystem(Window)
    -- FIXED: Force mouse unlock for first person games
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    
    -- FIXED: Key system ScreenGui with CoreGui override
    local keyScreen = new("ScreenGui", {
        Name = "KeySystem",
        ResetOnSpawn = false,
        DisplayOrder = 999999999,
        IgnoreGuiInset = true,
        ScreenInsets = Enum.ScreenInsets.DeviceSafeInsets,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    keyScreen.Parent = game:GetService("CoreGui") -- FIXED: CoreGui override

    -- Background blur with maximum ZIndex
    local keyBlurFrame = new("Frame", {
        Name = "KeyBlurContainer",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.new(0, 0, 0),
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Visible = true,
        ZIndex = 999999
    })
    keyBlurFrame.Parent = keyScreen

    -- Main key window with maximum ZIndex
    local keyWindow = new("Frame", {
        Name = "KeyWindow",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 400, 0, 250),
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        ZIndex = 1000000
    })
    keyWindow.Parent = keyBlurFrame
    
    local keyCorner = new("UICorner")
    keyCorner.CornerRadius = THEME.CornerRadius
    keyCorner.Parent = keyWindow

    -- Add glow effect
    createGlow(keyWindow, THEME.Primary)

    -- Close button
    local closeButton = new("TextButton", {
        Name = "CloseButton",
        Position = UDim2.new(1, -35, 0, 10),
        Size = UDim2.new(0, 25, 0, 25),
        BackgroundColor3 = THEME.Danger,
        BorderSizePixel = 0,
        Text = "×",
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        TextColor3 = THEME.Text,
        AutoButtonColor = false,
        ZIndex = 1000001
    })
    closeButton.Parent = keyWindow
    
    local closeCorner = new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton

    -- Title
    local title = new("TextLabel", {
        Name = "Title",
        Position = UDim2.new(0, 0, 0, 20),
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundTransparency = 1,
        Text = "Lynk Universal",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Center,
        ZIndex = 1000001
    })
    title.Parent = keyWindow

    -- Subtitle
    local subtitle = new("TextLabel", {
        Name = "Subtitle",
        Position = UDim2.new(0, 0, 0, 55),
        Size = UDim2.new(1, 0, 0, 20),
        BackgroundTransparency = 1,
        Text = "Key Login",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = THEME.TextSecondary,
        TextXAlignment = Enum.TextXAlignment.Center,
        ZIndex = 1000001
    })
    subtitle.Parent = keyWindow

    -- Key input
    local keyInput = new("TextBox", {
        Name = "KeyInput",
        Position = UDim2.new(0, 30, 0, 100),
        Size = UDim2.new(1, -60, 0, 35),
        BackgroundColor3 = THEME.Panel,
        BorderSizePixel = 0,
        PlaceholderText = "Enter your key here...",
        PlaceholderColor3 = THEME.TextMuted,
        Text = "",
        Font = Enum.Font.Gotham,
        TextSize = 12,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        ZIndex = 1000001
    })
    keyInput.Parent = keyWindow
    
    local inputCorner = new("UICorner")
    inputCorner.CornerRadius = THEME.SmallCornerRadius
    inputCorner.Parent = keyInput

    -- Add padding to input
    local inputPadding = new("UIPadding", {
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10)
    })
    inputPadding.Parent = keyInput

    -- Activate Key button
    local activateButton = new("TextButton", {
        Name = "ActivateButton",
        Position = UDim2.new(0, 30, 0, 155),
        Size = UDim2.new(0, 160, 0, 35),
        BackgroundColor3 = THEME.Warning,
        BorderSizePixel = 0,
        Text = "Activate Key",
        Font = Enum.Font.GothamSemibold,
        TextSize = 12,
        TextColor3 = Color3.new(0, 0, 0),
        AutoButtonColor = false,
        ZIndex = 1000001
    })
    activateButton.Parent = keyWindow
    
    local activateCorner = new("UICorner")
    activateCorner.CornerRadius = THEME.SmallCornerRadius
    activateCorner.Parent = activateButton

    -- Get Key button
    local getKeyButton = new("TextButton", {
        Name = "GetKeyButton",
        Position = UDim2.new(0, 210, 0, 155),
        Size = UDim2.new(0, 160, 0, 35),
        BackgroundColor3 = THEME.Panel,
        BorderSizePixel = 0,
        Text = "Get Key",
        Font = Enum.Font.GothamSemibold,
        TextSize = 12,
        TextColor3 = THEME.Text,
        AutoButtonColor = false,
        ZIndex = 1000001
    })
    getKeyButton.Parent = keyWindow
    
    local getKeyCorner = new("UICorner")
    getKeyCorner.CornerRadius = THEME.SmallCornerRadius
    getKeyCorner.Parent = getKeyButton

    -- Status message
    local statusMessage = new("TextLabel", {
        Name = "StatusMessage",
        Position = UDim2.new(0, 30, 0, 205),
        Size = UDim2.new(1, -60, 0, 20),
        BackgroundTransparency = 1,
        Text = "",
        Font = Enum.Font.Gotham,
        TextSize = 11,
        TextColor3 = THEME.TextSecondary,
        TextXAlignment = Enum.TextXAlignment.Center,
        ZIndex = 1000001
    })
    statusMessage.Parent = keyWindow

    -- Make window draggable
    local dragging = false
    local dragStart = nil
    local startPos = nil

    keyWindow.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = keyWindow.Position
        end
    end)

    keyWindow.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            keyWindow.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    keyWindow.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    -- Button animations
    local function animateKeyButton(button, hoverColor, normalColor)
        button.MouseEnter:Connect(function()
            TweenService:Create(button, THEME.FastTween, {BackgroundColor3 = hoverColor}):Play()
        end)
        button.MouseLeave:Connect(function()
            TweenService:Create(button, THEME.FastTween, {BackgroundColor3 = normalColor}):Play()
        end)
    end

    animateKeyButton(activateButton, Color3.fromRGB(255, 180, 40), THEME.Warning)
    animateKeyButton(getKeyButton, THEME.Card, THEME.Panel)
    animateKeyButton(closeButton, Color3.fromRGB(255, 80, 80), THEME.Danger)

    -- Get Key button functionality
    getKeyButton.MouseButton1Click:Connect(function()
        setclipboard(KEY_LINK)
        statusMessage.Text = "Link copied to clipboard! Paste it in your browser."
        statusMessage.TextColor3 = THEME.Success
        wait(3)
        statusMessage.Text = ""
    end)

    -- Close button functionality
    closeButton.MouseButton1Click:Connect(function()
        keyScreen:Destroy()
    end)

    -- Activate Key button functionality
    activateButton.MouseButton1Click:Connect(function()
        local enteredKey = keyInput.Text
        
        if enteredKey == "" then
            statusMessage.Text = "Please enter a key!"
            statusMessage.TextColor3 = THEME.Danger
            return
        end

        statusMessage.Text = "Checking key..."
        statusMessage.TextColor3 = THEME.TextSecondary
        
        wait(1)
        
        if enteredKey == VALID_KEY then
            statusMessage.Text = "Success!"
            statusMessage.TextColor3 = THEME.Success
            
            -- Fade out all elements simultaneously
            local fadeOutTweens = {}
            
            -- Fade background
            table.insert(fadeOutTweens, TweenService:Create(keyBlurFrame, THEME.MediumTween, {BackgroundTransparency = 1}))
            table.insert(fadeOutTweens, TweenService:Create(keyWindow, THEME.MediumTween, {BackgroundTransparency = 1}))
            
            -- Fade all child elements
            for _, child in pairs(keyWindow:GetChildren()) do
                if child:IsA("GuiObject") then
                    local fadeProps = {BackgroundTransparency = 1}
                    if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                        fadeProps.TextTransparency = 1
                    end
                    table.insert(fadeOutTweens, TweenService:Create(child, THEME.MediumTween, fadeProps))
                end
            end
            
            -- Play all fade tweens
            for _, tween in pairs(fadeOutTweens) do
                tween:Play()
            end
            
            -- Wait for fade to complete then destroy and unlock window
            wait(THEME.MediumTween.Time + 0.1)
            keyScreen:Destroy()
            
            -- FIXED: Unlock the window and show it
            Window._locked = false
            task.delay(0.1, function()
                Window:Show()
            end)
        else
            statusMessage.Text = "Invalid key!"
            statusMessage.TextColor3 = THEME.Danger
        end
    end)

    -- Enter key support
    keyInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            activateButton.MouseButton1Click:Fire()
        end
    end)

    return keyScreen
end

local Lynk = {}
Lynk.__index = Lynk

function Lynk:CreateWindow(opts)
    opts = opts or {}
    local Window = {}
    Window._tabs = {}
    Window._currentTab = nil
    Window._accent = opts.Accent or THEME.Primary
    Window._logo = opts.Logo or "rbxassetid://17673929618"
    Window._title = opts.Title or (opts.Name or "lynkUI v2.0")
    Window._subtitle = opts.Subtitle or "Universal Script Hub"
    Window._uiKey = opts.DefaultKeybind or Enum.KeyCode.Insert
    Window._shown = false
    Window._minimized = false

    -- Initialize notification system
    NotificationSystem:Initialize()

    -- FIXED: Gate the window but still build it (no early return)
    Window._locked = KEY_SYSTEM_ENABLED == true

    -- FIXED: Create ScreenGui with CoreGui override for maximum dominance
    local screen = new("ScreenGui", {
        Name = opts.Name or "lynkUI",
        ResetOnSpawn = false,
        DisplayOrder = 999999998, -- Just below key system
        IgnoreGuiInset = true,
        ScreenInsets = Enum.ScreenInsets.DeviceSafeInsets,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    screen.Parent = game:GetService("CoreGui") -- FIXED: CoreGui override

    -- Main container with blur effect
    local BlurFrame = new("Frame", {
        Name = "BlurContainer",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.new(0, 0, 0),
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Visible = false,
        ZIndex = 999998
    })
    BlurFrame.Parent = screen

    -- Main window outline
    local Outline = new("Frame", {
        Name = "Outline",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = THEME.Border,
        BorderSizePixel = 0,
        ZIndex = 999999
    })
    Outline.Parent = BlurFrame
    
    local outlineCorner = new("UICorner")
    outlineCorner.CornerRadius = THEME.CornerRadius
    outlineCorner.Parent = Outline

    -- Add subtle glow to outline
    createGlow(Outline, Window._accent)

    -- Main content frame
    local MainFrame = new("Frame", {
        Name = "MainFrame",
        Position = UDim2.new(0, 2, 0, 2),
        Size = UDim2.new(1, -4, 1, -4),
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        ZIndex = 1000000
    })
    MainFrame.Parent = Outline
    
    local mainCorner = new("UICorner")
    mainCorner.CornerRadius = THEME.CornerRadius
    mainCorner.Parent = MainFrame

    -- FIXED: Create minimized taskbar
    local MinimizedTaskbar = new("Frame", {
        Name = "MinimizedTaskbar",
        AnchorPoint = Vector2.new(0.5, 1),
        Position = UDim2.new(0.5, 0, 1, -20),
        Size = UDim2.new(0, 250, 0, 40),
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        Visible = false,
        ZIndex = 999999
    })
    MinimizedTaskbar.Parent = screen
    
    local taskbarCorner = new("UICorner")
    taskbarCorner.CornerRadius = THEME.SmallCornerRadius
    taskbarCorner.Parent = MinimizedTaskbar
    
    -- Taskbar border
    local taskbarBorder = new("UIStroke", {
        Color = THEME.Border,
        Thickness = 1
    })
    taskbarBorder.Parent = MinimizedTaskbar
    
    -- Taskbar title
    local TaskbarTitle = new("TextLabel", {
        Position = UDim2.new(0, 15, 0, 0),
        Size = UDim2.new(1, -80, 1, 0),
        BackgroundTransparency = 1,
        Text = "Lynk Universal",
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Center,
        ZIndex = 1000000
    })
    TaskbarTitle.Parent = MinimizedTaskbar
    
    -- Expand button
    local ExpandButton = new("TextButton", {
        Position = UDim2.new(1, -65, 0.5, -12),
        Size = UDim2.new(0, 25, 0, 25),
        BackgroundColor3 = THEME.Primary,
        BorderSizePixel = 0,
        Text = "⬜",
        Font = Enum.Font.GothamBold,
        TextSize = 12,
        TextColor3 = THEME.Text,
        AutoButtonColor = false,
        ZIndex = 1000000
    })
    ExpandButton.Parent = MinimizedTaskbar
    
    local expandCorner = new("UICorner")
    expandCorner.CornerRadius = UDim.new(0, 4)
    expandCorner.Parent = ExpandButton
    
    -- Taskbar close button
    local TaskbarCloseButton = new("TextButton", {
        Position = UDim2.new(1, -35, 0.5, -12),
        Size = UDim2.new(0, 25, 0, 25),
        BackgroundColor3 = THEME.Danger,
        BorderSizePixel = 0,
        Text = "×",
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextColor3 = THEME.Text,
        AutoButtonColor = false,
        ZIndex = 1000000
    })
    TaskbarCloseButton.Parent = MinimizedTaskbar
    
    local taskbarCloseCorner = new("UICorner")
    taskbarCloseCorner.CornerRadius = UDim.new(0, 4)
    taskbarCloseCorner.Parent = TaskbarCloseButton

    -- Make taskbar draggable
    local taskbarDragging = false
    local taskbarDragStart = nil
    local taskbarStartPos = nil

    MinimizedTaskbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            taskbarDragging = true
            taskbarDragStart = input.Position
            taskbarStartPos = MinimizedTaskbar.Position
        end
    end)

    MinimizedTaskbar.InputChanged:Connect(function(input)
        if taskbarDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - taskbarDragStart
            MinimizedTaskbar.Position = UDim2.new(taskbarStartPos.X.Scale, taskbarStartPos.X.Offset + delta.X, taskbarStartPos.Y.Scale, taskbarStartPos.Y.Offset + delta.Y)
        end
    end)

    MinimizedTaskbar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            taskbarDragging = false
        end
    end)

    -- Sidebar (left panel)
    local Sidebar = new("Frame", {
        Name = "Sidebar",
        Size = UDim2.new(0, 280, 1, 0),
        BackgroundColor3 = THEME.Surface,
        BorderSizePixel = 0,
        ZIndex = 1000001
    })
    Sidebar.Parent = MainFrame
    
    local sidebarCorner = new("UICorner")
    sidebarCorner.CornerRadius = THEME.CornerRadius
    sidebarCorner.Parent = Sidebar

    -- Sidebar gradient
    createGradient(Sidebar, {
        ColorSequenceKeypoint.new(0, THEME.Surface),
        ColorSequenceKeypoint.new(1, THEME.Panel)
    }, 90)

    -- Player Profile Section
    local ProfileContainer = new("Frame", {
        Name = "ProfileContainer",
        Position = UDim2.new(0, 20, 0, 20),
        Size = UDim2.new(1, -40, 0, 80),
        BackgroundColor3 = THEME.Card,
        BorderSizePixel = 0,
        ZIndex = 1000002
    })
    ProfileContainer.Parent = Sidebar
    
    local profileCorner = new("UICorner")
    profileCorner.CornerRadius = THEME.SmallCornerRadius
    profileCorner.Parent = ProfileContainer

    -- Player avatar (circular)
    local AvatarContainer = new("Frame", {
        Name = "AvatarContainer",
        Position = UDim2.new(0, 12, 0, 12),
        Size = UDim2.new(0, 56, 0, 56),
        BackgroundColor3 = THEME.Primary,
        BorderSizePixel = 0,
        ZIndex = 1000003
    })
    AvatarContainer.Parent = ProfileContainer
    
    local avatarCorner = new("UICorner")
    avatarCorner.CornerRadius = UDim.new(0.5, 0)
    avatarCorner.Parent = AvatarContainer

    local PlayerAvatar = new("ImageLabel", {
        Name = "PlayerAvatar",
        Position = UDim2.new(0, 2, 0, 2),
        Size = UDim2.new(1, -4, 1, -4),
        Image = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420),
        BackgroundTransparency = 1,
        ScaleType = Enum.ScaleType.Crop,
        ZIndex = 1000004
    })
    PlayerAvatar.Parent = AvatarContainer
    
    local playerAvatarCorner = new("UICorner")
    playerAvatarCorner.CornerRadius = UDim.new(0.5, 0)
    playerAvatarCorner.Parent = PlayerAvatar

    -- Player username
    local PlayerName = new("TextLabel", {
        Name = "PlayerName",
        Position = UDim2.new(0, 80, 0, 15),
        Size = UDim2.new(1, -92, 0, 24),
        BackgroundTransparency = 1,
        Text = "@" .. LocalPlayer.Name,
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ZIndex = 1000003
    })
    PlayerName.Parent = ProfileContainer

    -- Online status indicator
    local StatusIndicator = new("Frame", {
        Name = "StatusIndicator",
        Position = UDim2.new(0, 80, 0, 42),
        Size = UDim2.new(0, 8, 0, 8),
        BackgroundColor3 = THEME.Success,
        BorderSizePixel = 0,
        ZIndex = 1000003
    })
    StatusIndicator.Parent = ProfileContainer
    
    local statusCorner = new("UICorner")
    statusCorner.CornerRadius = UDim.new(0.5, 0)
    statusCorner.Parent = StatusIndicator

    local StatusText = new("TextLabel", {
        Name = "StatusText",
        Position = UDim2.new(0, 96, 0, 38),
        Size = UDim2.new(1, -108, 0, 16),
        BackgroundTransparency = 1,
        Text = "Online",
        Font = Enum.Font.Gotham,
        TextSize = 12,
        TextColor3 = THEME.TextSecondary,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 1000003
    })
    StatusText.Parent = ProfileContainer

    -- Tabs container
    local TabsContainer = new("Frame", {
        Name = "TabsContainer",
        Position = UDim2.new(0, 20, 0, 120),
        Size = UDim2.new(1, -40, 1, -140),
        BackgroundTransparency = 1,
        ZIndex = 1000002
    })
    TabsContainer.Parent = Sidebar

    local tabsLayout = new("UIListLayout")
    tabsLayout.Parent = TabsContainer
    tabsLayout.Padding = UDim.new(0, 8)
    tabsLayout.SortOrder = Enum.SortOrder.LayoutOrder

    -- Content area
    local ContentArea = new("Frame", {
        Name = "ContentArea",
        Position = UDim2.new(0, 280, 0, 0),
        Size = UDim2.new(1, -280, 1, 0),
        BackgroundTransparency = 1,
        ZIndex = 1000001
    })
    ContentArea.Parent = MainFrame

    -- Top bar in content area
    local TopBar = new("Frame", {
        Name = "TopBar",
        Size = UDim2.new(1, 0, 0, 80),
        BackgroundTransparency = 1,
        ZIndex = 1000002
    })
    TopBar.Parent = ContentArea

    -- Title section
    local TitleContainer = new("Frame", {
        Name = "TitleContainer",
        Position = UDim2.new(0, 30, 0, 20),
        Size = UDim2.new(0.5, 0, 0, 40),
        BackgroundTransparency = 1,
        ZIndex = 1000003
    })
    TitleContainer.Parent = TopBar

    local MainTitle = new("TextLabel", {
        Name = "MainTitle",
        Size = UDim2.new(1, 0, 0, 24),
        BackgroundTransparency = 1,
        Text = Window._title,
        Font = Enum.Font.GothamBold,
        TextSize = 24,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 1000004
    })
    MainTitle.Parent = TitleContainer

    local Subtitle = new("TextLabel", {
        Name = "Subtitle",
        Position = UDim2.new(0, 0, 0, 24),
        Size = UDim2.new(1, 0, 0, 16),
        BackgroundTransparency = 1,
        Text = Window._subtitle,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = THEME.TextMuted,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 1000004
    })
    Subtitle.Parent = TitleContainer

    -- FIXED: Minimize button
    local MinimizeButton = new("TextButton", {
        Name = "MinimizeButton",
        Position = UDim2.new(1, -110, 0, 20),
        Size = UDim2.new(0, 40, 0, 40),
        BackgroundColor3 = THEME.Warning,
        Text = "−",
        Font = Enum.Font.GothamBold,
        TextSize = 20,
        TextColor3 = Color3.new(0, 0, 0),
        AutoButtonColor = false,
        ZIndex = 1000003
    })
    MinimizeButton.Parent = TopBar
    
    local minimizeCorner = new("UICorner")
    minimizeCorner.CornerRadius = THEME.SmallCornerRadius
    minimizeCorner.Parent = MinimizeButton

    -- Close button
    local CloseButton = new("TextButton", {
        Name = "CloseButton",
        Position = UDim2.new(1, -60, 0, 20),
        Size = UDim2.new(0, 40, 0, 40),
        BackgroundColor3 = THEME.Danger,
        Text = "×",
        Font = Enum.Font.GothamBold,
        TextSize = 20,
        TextColor3 = THEME.Text,
        AutoButtonColor = false,
        ZIndex = 1000003
    })
    CloseButton.Parent = TopBar
    
    local closeCorner = new("UICorner")
    closeCorner.CornerRadius = THEME.SmallCornerRadius
    closeCorner.Parent = CloseButton

    -- Button hover effects
    local function animateButton(button, hoverColor, normalColor)
        button.MouseEnter:Connect(function()
            TweenService:Create(button, THEME.FastTween, {BackgroundColor3 = hoverColor}):Play()
        end)
        button.MouseLeave:Connect(function()
            TweenService:Create(button, THEME.FastTween, {BackgroundColor3 = normalColor}):Play()
        end)
    end
    
    animateButton(CloseButton, Color3.fromRGB(220, 50, 50), THEME.Danger)
    animateButton(MinimizeButton, Color3.fromRGB(255, 180, 40), THEME.Warning)
    animateButton(ExpandButton, Color3.fromRGB(100, 120, 255), THEME.Primary)
    animateButton(TaskbarCloseButton, Color3.fromRGB(220, 50, 50), THEME.Danger)

    -- FIXED: Create confirmation popup with better fade animation
    local ConfirmationPopup = new("Frame", {
        Name = "ConfirmationPopup",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        Visible = false,
        ZIndex = 1000100
    })
    ConfirmationPopup.Parent = BlurFrame
    
    local popupCorner = new("UICorner")
    popupCorner.CornerRadius = THEME.CornerRadius
    popupCorner.Parent = ConfirmationPopup

    -- Popup outline
    local PopupOutline = new("UIStroke", {
        Color = THEME.Border,
        Thickness = 2
    })
    PopupOutline.Parent = ConfirmationPopup

    -- Popup title
    local PopupTitle = new("TextLabel", {
        Name = "PopupTitle",
        Position = UDim2.new(0, 20, 0, 20),
        Size = UDim2.new(1, -40, 0, 30),
        BackgroundTransparency = 1,
        Text = "Confirm Close",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        TextColor3 = THEME.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 1000101
    })
    PopupTitle.Parent = ConfirmationPopup

    -- Popup message
    local PopupMessage = new("TextLabel", {
        Name = "PopupMessage",
        Position = UDim2.new(0, 20, 0, 60),
        Size = UDim2.new(1, -40, 0, 60),
        BackgroundTransparency = 1,
        Text = "Are you sure you want to close?\nInstead press Insert to toggle the UI.",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = THEME.TextSecondary,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true,
        ZIndex = 1000101
    })
    PopupMessage.Parent = ConfirmationPopup

    -- Yes button (green)
    local YesButton = new("TextButton", {
        Name = "YesButton",
        Position = UDim2.new(0, 20, 1, -60),
        Size = UDim2.new(0, 100, 0, 40),
        BackgroundColor3 = Color3.fromRGB(46, 160, 67),
        Text = "Yes",
        Font = Enum.Font.GothamSemibold,
        TextSize = 16,
        TextColor3 = Color3.new(1, 1, 1),
        AutoButtonColor = false,
        ZIndex = 1000101
    })
    YesButton.Parent = ConfirmationPopup
    
    local yesCorner = new("UICorner")
    yesCorner.CornerRadius = THEME.SmallCornerRadius
    yesCorner.Parent = YesButton

    -- No button (red)
    local NoButton = new("TextButton", {
        Name = "NoButton",
        Position = UDim2.new(1, -120, 1, -60),
        Size = UDim2.new(0, 100, 0, 40),
        BackgroundColor3 = Color3.fromRGB(220, 50, 50),
        Text = "No",
        Font = Enum.Font.GothamSemibold,
        TextSize = 16,
        TextColor3 = Color3.new(1, 1, 1),
        AutoButtonColor = false,
        ZIndex = 1000101
    })
    NoButton.Parent = ConfirmationPopup
    
    local noCorner = new("UICorner")
    noCorner.CornerRadius = THEME.SmallCornerRadius
    noCorner.Parent = NoButton

    -- Button hover effects for popup buttons
    animateButton(YesButton, Color3.fromRGB(56, 180, 77), Color3.fromRGB(46, 160, 67))
    animateButton(NoButton, Color3.fromRGB(240, 70, 70), Color3.fromRGB(220, 50, 50))

    -- Modified close button to show popup instead of directly closing
    CloseButton.MouseButton1Click:Connect(function()
        ConfirmationPopup.Visible = true
        -- Animate popup appearance
        ConfirmationPopup.Size = UDim2.new(0, 0, 0, 0)
        TweenService:Create(ConfirmationPopup, THEME.MediumTween, {
            Size = UDim2.new(0, 400, 0, 200)
        }):Play()
    end)

    -- Yes button closes the entire UI
    YesButton.MouseButton1Click:Connect(function()
        Window:Destroy()
    end)

    -- FIXED: No button with better fade animation
    NoButton.MouseButton1Click:Connect(function()
        -- Fade all popup elements simultaneously
        local fadeOutTweens = {}
        
        -- Fade popup background
        table.insert(fadeOutTweens, TweenService:Create(ConfirmationPopup, THEME.FastTween, {BackgroundTransparency = 1}))
        table.insert(fadeOutTweens, TweenService:Create(PopupOutline, THEME.FastTween, {Transparency = 1}))
        
        -- Fade all child elements
        for _, child in pairs(ConfirmationPopup:GetChildren()) do
            if child:IsA("GuiObject") then
                local fadeProps = {BackgroundTransparency = 1}
                if child:IsA("TextLabel") or child:IsA("TextButton") then
                    fadeProps.TextTransparency = 1
                end
                table.insert(fadeOutTweens, TweenService:Create(child, THEME.FastTween, fadeProps))
            end
        end
        
        -- Play all fade tweens
        for _, tween in pairs(fadeOutTweens) do
            tween:Play()
        end
        
        wait(THEME.FastTween.Time + 0.1)
        ConfirmationPopup.Visible = false
        
        -- Reset transparency for next use
        ConfirmationPopup.BackgroundTransparency = 0
        PopupOutline.Transparency = 0
        for _, child in pairs(ConfirmationPopup:GetChildren()) do
            if child:IsA("GuiObject") then
                child.BackgroundTransparency = child.Name == "PopupTitle" and 1 or 0
                if child:IsA("TextLabel") or child:IsA("TextButton") then
                    child.TextTransparency = 0
                end
            end
        end
    end)

    -- Taskbar close button functionality
    TaskbarCloseButton.MouseButton1Click:Connect(function()
        Window:Destroy()
    end)

    -- Pages container with smooth transitions
    local PagesContainer = new("Frame", {
        Name = "PagesContainer",
        Position = UDim2.new(0, 30, 0, 80),
        Size = UDim2.new(1, -60, 1, -100),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        ZIndex = 1000002
    })
    PagesContainer.Parent = ContentArea

    -- Store references
    Window._screen = screen
    Window._blurFrame = BlurFrame
    Window._outline = Outline
    Window._mainFrame = MainFrame
    Window._sidebar = Sidebar
    Window._tabsContainer = TabsContainer
    Window._pagesContainer = PagesContainer
    Window._titleLabel = MainTitle
    Window._subtitleLabel = Subtitle
    Window._minimizedTaskbar = MinimizedTaskbar

    -- Dragging functionality
    local dragging = false
    local dragStart = nil
    local startPos = nil

    local function updateDrag(input)
        if dragging then
            local delta = input.Position - dragStart
            local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, 
                                   startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            TweenService:Create(Outline, THEME.FastTween, {Position = newPos}):Play()
        end
    end

    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Outline.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    TopBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            updateDrag(input)
        end
    end)

    -- FIXED: Window visibility toggle with proper minimize/maximize states
    local isVisible = false
    
    local function setVisibility(visible)
        isVisible = visible
        BlurFrame.Visible = visible
        
        if visible then
            -- Animate window opening
            Outline.Size = UDim2.new(0, 0, 0, 0)
            TweenService:Create(Outline, THEME.SlowTween, {
                Size = THEME.WindowSize
            }):Play()
        else
            -- Animate window closing
            TweenService:Create(Outline, THEME.MediumTween, {
                Size = UDim2.new(0, 0, 0, 0)
            }):Play()
            
            task.wait(0.25)
            if not isVisible then
                BlurFrame.Visible = false
            end
        end
    end

    -- FIXED: Show/Hide functions that respect the lock and minimize state
    function Window:Show()
        if Window._locked then return end
        if Window._minimized then
            Window:Maximize()
            return
        end
        if isVisible then return end
        setVisibility(true)
        NotificationSystem:CreateNotification("UI Shown", "User interface is now visible", "success")
        -- Load script cards on first show
        if not Window._cardsLoaded then
            Window:LoadScriptCards()
            Window._cardsLoaded = true
        end
    end

    function Window:Hide()
        if Window._minimized then return end
        if not isVisible then return end
        setVisibility(false)
        NotificationSystem:CreateNotification("UI Hidden", "User interface is now hidden", "info")
    end

    -- FIXED: Minimize/Maximize functions
    function Window:Minimize()
        if Window._minimized or not isVisible then return end
        Window._minimized = true
        
        -- Hide main UI
        setVisibility(false)
        
        -- Show taskbar
        MinimizedTaskbar.Visible = true
        MinimizedTaskbar.Position = UDim2.new(0.5, 0, 1, 20)
        TweenService:Create(MinimizedTaskbar, THEME.MediumTween, {
            Position = UDim2.new(0.5, 0, 1, -20)
        }):Play()
        
        NotificationSystem:CreateNotification("UI Minimized", "User interface minimized to taskbar", "info")
    end

    function Window:Maximize()
        if not Window._minimized then return end
        Window._minimized = false
        
        -- Hide taskbar
        TweenService:Create(MinimizedTaskbar, THEME.MediumTween, {
            Position = UDim2.new(0.5, 0, 1, 20)
        }):Play()
        
        task.wait(0.25)
        MinimizedTaskbar.Visible = false
        
        -- Show main UI
        setVisibility(true)
        NotificationSystem:CreateNotification("UI Maximized", "User interface restored from taskbar", "success")
    end

    -- Button click handlers
    MinimizeButton.MouseButton1Click:Connect(function()
        Window:Minimize()
    end)

    ExpandButton.MouseButton1Click:Connect(function()
        Window:Maximize()
    end)

    -- FIXED: Keybind listener that handles all states properly
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Window._uiKey then
            if Window._locked then return end -- ignore until unlocked
            
            if Window._minimized then
                Window:Maximize()
            elseif isVisible then
                Window:Hide()
            else
                Window:Show()
            end
        end
    end)

    -- Tab creation and management
    function Window:CreateTab(name, icon, layoutOrder)
        local tab = {
            Name = name,
            Icon = icon or "",
            LayoutOrder = layoutOrder or (#Window._tabs + 1),
            Active = false
        }

        -- Tab button
        local TabButton = new("TextButton", {
            Name = name .. "_TabButton",
            Size = UDim2.new(1, 0, 0, 48),
            BackgroundColor3 = Color3.fromRGB(0, 0, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false,
            LayoutOrder = tab.LayoutOrder,
            ZIndex = 1000003
        })
        TabButton.Parent = TabsContainer
        
        local tabCorner = new("UICorner")
        tabCorner.CornerRadius = THEME.SmallCornerRadius
        tabCorner.Parent = TabButton

        -- Tab icon
        local TabIcon = new("ImageLabel", {
            Name = "TabIcon",
            Position = UDim2.new(0, 16, 0.5, -10),
            Size = UDim2.new(0, 20, 0, 20),
            BackgroundTransparency = 1,
            Image = tab.Icon,
            ImageColor3 = THEME.TextMuted,
            ScaleType = Enum.ScaleType.Fit,
            ZIndex = 1000004
        })
        TabIcon.Parent = TabButton

        -- Tab text
        local TabText = new("TextLabel", {
            Name = "TabText",
            Position = UDim2.new(0, 48, 0, 0),
            Size = UDim2.new(1, -60, 1, 0),
            BackgroundTransparency = 1,
            Text = name,
            Font = Enum.Font.GothamSemibold,
            TextSize = 15,
            TextColor3 = THEME.TextMuted,
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 1000004
        })
        TabText.Parent = TabButton

        -- Active indicator
        local ActiveIndicator = new("Frame", {
            Name = "ActiveIndicator",
            Position = UDim2.new(0, 0, 0.5, -12),
            Size = UDim2.new(0, 3, 0, 24),
            BackgroundColor3 = Window._accent,
            BorderSizePixel = 0,
            Visible = false,
            ZIndex = 1000004
        })
        ActiveIndicator.Parent = TabButton
        
        local indicatorCorner = new("UICorner")
        indicatorCorner.CornerRadius = UDim.new(0, 2)
        indicatorCorner.Parent = ActiveIndicator

        -- Tab page
        local TabPage = new("Frame", {
            Name = name .. "_Page",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Visible = false,
            ZIndex = 1000003
        })
        TabPage.Parent = PagesContainer

        -- Tab functions
        function tab:Show()
            -- Hide all other tabs
            for _, otherTab in pairs(Window._tabs) do
                if otherTab ~= tab then
                    otherTab:Hide()
                end
            end
            
            -- Show this tab
            tab.Active = true
            Window._currentTab = tab
            
            -- Animate tab appearance
            TabPage.Position = UDim2.new(1, 0, 0, 0)
            TabPage.Visible = true
            
            TweenService:Create(TabPage, THEME.MediumTween, {
                Position = UDim2.new(0, 0, 0, 0)
            }):Play()
            
            -- Update button appearance
            TweenService:Create(TabButton, THEME.FastTween, {
                BackgroundTransparency = 0,
                BackgroundColor3 = Color3.fromRGB(255, 255, 255):lerp(Window._accent, 0.9)
            }):Play()
            TweenService:Create(TabText, THEME.FastTween, {TextColor3 = THEME.Text}):Play()
            TweenService:Create(TabIcon, THEME.FastTween, {ImageColor3 = Window._accent}):Play()
            ActiveIndicator.Visible = true
        end
        
        function tab:Hide()
            tab.Active = false
            
            -- Animate tab disappearance
            if TabPage.Visible then
                TweenService:Create(TabPage, THEME.FastTween, {
                    Position = UDim2.new(-1, 0, 0, 0)
                }):Play()
                
                task.wait(0.15)
                TabPage.Visible = false
                TabPage.Position = UDim2.new(0, 0, 0, 0)
            end
            
            -- Reset button appearance
            TweenService:Create(TabButton, THEME.FastTween, {
                BackgroundTransparency = 1
            }):Play()
            TweenService:Create(TabText, THEME.FastTween, {TextColor3 = THEME.TextMuted}):Play()
            TweenService:Create(TabIcon, THEME.FastTween, {ImageColor3 = THEME.TextMuted}):Play()
            ActiveIndicator.Visible = false
        end

        -- Button hover effects
        TabButton.MouseEnter:Connect(function()
            if not tab.Active then
                TweenService:Create(TabButton, THEME.FastTween, {
                    BackgroundTransparency = 0.95,
                    BackgroundColor3 = THEME.TextMuted
                }):Play()
            end
        end)
        
        TabButton.MouseLeave:Connect(function()
            if not tab.Active then
                TweenService:Create(TabButton, THEME.FastTween, {
                    BackgroundTransparency = 1
                }):Play()
            end
        end)

        TabButton.MouseButton1Click:Connect(function()
            tab:Show()
        end)

        -- Store references
        tab.Button = TabButton
        tab.Page = TabPage
        tab.Icon = TabIcon
        tab.Text = TabText

        Window._tabs[#Window._tabs + 1] = tab
        return tab
    end

    -- FIXED: Function to create content in tabs (for loader script use)
    function Window:CreateLabel(parent, text, textSize)
        local label = new("TextLabel", {
            Size = UDim2.new(1, 0, 0, textSize and (textSize + 10) or 30),
            BackgroundTransparency = 1,
            Text = text or "Label",
            Font = Enum.Font.Gotham,
            TextSize = textSize or 14,
            TextColor3 = THEME.Text,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextYAlignment = Enum.TextYAlignment.Center,
            TextWrapped = true,
            ZIndex = 1000004
        })
        label.Parent = parent
        return label
    end

    function Window:CreateButton(parent, text, callback)
        local button = new("TextButton", {
            Size = UDim2.new(1, 0, 0, 40),
            BackgroundColor3 = Window._accent,
            BorderSizePixel = 0,
            Text = text or "Button",
            Font = Enum.Font.GothamSemibold,
            TextSize = 14,
            TextColor3 = THEME.Text,
            AutoButtonColor = false,
            ZIndex = 1000004
        })
        button.Parent = parent
        
        local corner = new("UICorner")
        corner.CornerRadius = THEME.SmallCornerRadius
        corner.Parent = button

        -- Hover effects
        button.MouseEnter:Connect(function()
            TweenService:Create(button, THEME.FastTween, {
                BackgroundColor3 = button.BackgroundColor3:lerp(Color3.new(1,1,1), 0.1)
            }):Play()
        end)
        
        button.MouseLeave:Connect(function()
            TweenService:Create(button, THEME.FastTween, {
                BackgroundColor3 = Window._accent
            }):Play()
        end)

        if callback then
            button.MouseButton1Click:Connect(callback)
        end

        return button
    end

    function Window:Destroy()
        NotificationSystem:Cleanup()
        if screen and screen.Parent then
            screen:Destroy()
        end
    end

    -- FIXED: Database helper function
    local function DB()
        return Window._scriptDatabase or SCRIPT_DATABASE
    end

    -- FIXED: Populate functions for all tabs with proper content
    local function populateUpdatesTab(updatesTab)
        -- Clear existing content
        for _, child in pairs(updatesTab:GetChildren()) do
            if child:IsA("GuiObject") then
                child:Destroy()
            end
        end
        
        -- Create scroll frame for updates content
        local ScrollFrame = new("ScrollingFrame", {
            Name = "UpdatesScrollFrame",
            Position = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 6,
            ScrollBarImageColor3 = THEME.TextMuted,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ZIndex = 1000004
        })
        ScrollFrame.Parent = updatesTab
        
        local layout = new("UIListLayout")
        layout.Parent = ScrollFrame
        layout.Padding = UDim.new(0, 8)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        
        local padding = new("UIPadding")
        padding.Parent = ScrollFrame
        padding.PaddingAll = UDim.new(0, 20)
        
        -- FIXED: Add updates content with proper ZIndex
        local updates = {
            {text = "📋 Recent Updates", size = 18, color = Window._accent, bold = true},
            {text = "", size = 10, color = THEME.Text, bold = false},
            {text = "🔄 Version 2.2.0:", size = 16, color = THEME.Text, bold = true},
            {text = "• Fixed minimize/maximize functionality", size = 14, color = THEME.Text, bold = false},
            {text = "• Added CoreGui override for all UI elements", size = 14, color = THEME.Text, bold = false},
            {text = "• Fixed key symbol detection (RequiresKey)", size = 14, color = THEME.Text, bold = false},
            {text = "• Added notification system with sounds", size = 14, color = THEME.Text, bold = false},
            {text = "• Fixed Home tab auto-loading", size = 14, color = THEME.Text, bold = false},
            {text = "• Improved popup animations", size = 14, color = THEME.Text, bold = false},
            {text = "", size = 10, color = THEME.Text, bold = false},
            {text = "🔄 Version 2.1.0:", size = 16, color = THEME.Text, bold = true},
            {text = "• Improved UI performance", size = 14, color = THEME.Text, bold = false},
            {text = "• Added new script categories", size = 14, color = THEME.Text, bold = false},
            {text = "• Enhanced search functionality", size = 14, color = THEME.Text, bold = false}
        }
        
        for i, update in ipairs(updates) do
            local updateLabel = new("TextLabel", {
                Name = "Update" .. i,
                Size = UDim2.new(1, 0, 0, update.size + 5),
                BackgroundTransparency = 1,
                Text = update.text,
                Font = update.bold and Enum.Font.GothamBold or Enum.Font.Gotham,
                TextSize = update.size,
                TextColor3 = update.color,
                TextXAlignment = Enum.TextXAlignment.Left,
                LayoutOrder = i,
                ZIndex = 1000005
            })
            updateLabel.Parent = ScrollFrame
        end
    end

    local function populateCreditsTab(creditsTab)
        -- Clear existing content
        for _, child in pairs(creditsTab:GetChildren()) do
            if child:IsA("GuiObject") then
                child:Destroy()
            end
        end
        
        -- Create scroll frame for credits content
        local ScrollFrame = new("ScrollingFrame", {
            Name = "CreditsScrollFrame",
            Position = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 6,
            ScrollBarImageColor3 = THEME.TextMuted,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ZIndex = 1000004
        })
        ScrollFrame.Parent = creditsTab
        
        local layout = new("UIListLayout")
        layout.Parent = ScrollFrame
        layout.Padding = UDim.new(0, 8)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        
        local padding = new("UIPadding")
        padding.Parent = ScrollFrame
        padding.PaddingAll = UDim.new(0, 20)
        
        -- Add credits content
        local credits = {
            {text = "🚀 LYNK Script Hub v2.2", size = 18, color = Window._accent, bold = true},
            {text = "", size = 10, color = THEME.Text, bold = false},
            {text = "👨‍💻 Development Team:", size = 16, color = THEME.Text, bold = true},
            {text = "• @x_vvw - Lead Developer", size = 14, color = THEME.Text, bold = false},
            {text = "• Script Hub Community", size = 14, color = THEME.Text, bold = false},
            {text = "", size = 10, color = THEME.Text, bold = false},
            {text = "🎨 Features:", size = 16, color = THEME.Text, bold = true},
            {text = "• Modern GitHub integration", size = 14, color = THEME.Text, bold = false},
            {text = "• Auto game detection", size = 14, color = THEME.Text, bold = false},
            {text = "• Professional card layout", size = 14, color = THEME.Text, bold = false},
            {text = "• Smart search system", size = 14, color = THEME.Text, bold = false},
            {text = "• Minimize/maximize functionality", size = 14, color = THEME.Text, bold = false},
            {text = "• Notification system with sounds", size = 14, color = THEME.Text, bold = false},
            {text = "", size = 10, color = THEME.Text, bold = false},
            {text = "https://discord.gg/AzMbjqD7T3", size = 14, color = Window._accent, bold = false}
        }
        
        for i, credit in ipairs(credits) do
            local creditLabel = new("TextLabel", {
                Name = "Credit" .. i,
                Size = UDim2.new(1, 0, 0, credit.size + 5),
                BackgroundTransparency = 1,
                Text = credit.text,
                Font = credit.bold and Enum.Font.GothamBold or Enum.Font.Gotham,
                TextSize = credit.size,
                TextColor3 = credit.color,
                TextXAlignment = Enum.TextXAlignment.Left,
                LayoutOrder = i,
                ZIndex = 1000005
            })
            creditLabel.Parent = ScrollFrame
        end
    end

    local function populateSettingsTab(settingsTab)
        -- Clear existing content
        for _, child in pairs(settingsTab:GetChildren()) do
            if child:IsA("GuiObject") then
                child:Destroy()
            end
        end
        
        -- Create scroll frame for settings content
        local ScrollFrame = new("ScrollingFrame", {
            Name = "SettingsScrollFrame",
            Position = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 6,
            ScrollBarImageColor3 = THEME.TextMuted,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ZIndex = 1000004
        })
        ScrollFrame.Parent = settingsTab
        
        local layout = new("UIListLayout")
        layout.Parent = ScrollFrame
        layout.Padding = UDim.new(0, 15)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        
        local padding = new("UIPadding")
        padding.Parent = ScrollFrame
        padding.PaddingAll = UDim.new(0, 20)
        
        -- Key selector for UI toggle
        local keyBindFrame = new("Frame", {
            Name = "KeyBindFrame",
            Size = UDim2.new(1, 0, 0, 50),
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BorderSizePixel = 0,
            LayoutOrder = 1,
            ZIndex = 1000005
        })
        keyBindFrame.Parent = ScrollFrame
        
        local keyCorner = new("UICorner")
        keyCorner.CornerRadius = UDim.new(0, 8)
        keyCorner.Parent = keyBindFrame
        
        local keyTitle = new("TextLabel", {
            Name = "KeyTitle",
            Position = UDim2.new(0, 15, 0, 0),
            Size = UDim2.new(0.6, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "UI Toggle Key",
            Font = Enum.Font.GothamSemibold,
            TextSize = 14,
            TextColor3 = THEME.Text,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextYAlignment = Enum.TextYAlignment.Center,
            ZIndex = 1000006
        })
        keyTitle.Parent = keyBindFrame
        
        local keyButton = new("TextButton", {
            Name = "KeyButton",
            Position = UDim2.new(1, -120, 0.5, -15),
            Size = UDim2.new(0, 100, 0, 30),
            BackgroundColor3 = Color3.fromRGB(60, 60, 60),
            BorderSizePixel = 0,
            Text = "Insert",
            Font = Enum.Font.Gotham,
            TextSize = 12,
            TextColor3 = THEME.Text,
            AutoButtonColor = false,
            ZIndex = 1000006
        })
        keyButton.Parent = keyBindFrame
        
        local buttonCorner = new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 6)
        buttonCorner.Parent = keyButton
        
        -- Key mapping for display names
        local keyNames = {
            [Enum.KeyCode.Insert] = "Insert",
            [Enum.KeyCode.Home] = "Home",
            [Enum.KeyCode.End] = "End",
            [Enum.KeyCode.PageUp] = "PgUp",
            [Enum.KeyCode.PageDown] = "PgDn",
            [Enum.KeyCode.Delete] = "Delete",
            [Enum.KeyCode.F1] = "F1",
            [Enum.KeyCode.F2] = "F2",
            [Enum.KeyCode.F3] = "F3",
            [Enum.KeyCode.F4] = "F4",
            [Enum.KeyCode.F5] = "F5",
            [Enum.KeyCode.F6] = "F6",
            [Enum.KeyCode.F7] = "F7",
            [Enum.KeyCode.F8] = "F8",
            [Enum.KeyCode.F9] = "F9",
            [Enum.KeyCode.F10] = "F10",
            [Enum.KeyCode.F11] = "F11",
            [Enum.KeyCode.F12] = "F12",
            [Enum.KeyCode.LeftControl] = "LCtrl",
            [Enum.KeyCode.RightControl] = "RCtrl",
            [Enum.KeyCode.LeftShift] = "LShift",
            [Enum.KeyCode.RightShift] = "RShift"
        }
        
        local isBinding = false
        
        keyButton.MouseButton1Click:Connect(function()
            if not isBinding then
                isBinding = true
                keyButton.Text = "..."
                keyButton.TextColor3 = Window._accent
                
                local connection
                connection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
                    if gameProcessed then return end
                    if input.UserInputType == Enum.UserInputType.Keyboard then
                        local newKey = input.KeyCode
                        local keyName = keyNames[newKey] or tostring(newKey):gsub("Enum.KeyCode.", "")
                        
                        -- Update the UI key
                        Window._uiKey = newKey
                        keyButton.Text = keyName
                        keyButton.TextColor3 = THEME.Text
                        
                        connection:Disconnect()
                        isBinding = false
                    end
                end)
            end
        end)
        
        -- Refresh Database Button
        local refreshFrame = new("Frame", {
            Name = "RefreshFrame",
            Size = UDim2.new(1, 0, 0, 50),
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BorderSizePixel = 0,
            LayoutOrder = 2,
            ZIndex = 1000005
        })
        refreshFrame.Parent = ScrollFrame
        
        local refreshCorner = new("UICorner")
        refreshCorner.CornerRadius = UDim.new(0, 8)
        refreshCorner.Parent = refreshFrame
        
        local refreshButton = new("TextButton", {
            Name = "RefreshButton",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "🔄 Refresh Database",
            Font = Enum.Font.GothamSemibold,
            TextSize = 14,
            TextColor3 = THEME.Text,
            AutoButtonColor = false,
            ZIndex = 1000006
        })
        refreshButton.Parent = refreshFrame
        
        refreshButton.MouseButton1Click:Connect(function()
            refreshButton.Text = "🔄 Refreshing..."
            refreshButton.TextColor3 = Window._accent
            
            task.wait(0.5)
            
            refreshButton.Text = "✅ Database Refreshed!"
            NotificationSystem:CreateNotification("Database Refreshed", "Script database has been updated", "success")
            task.wait(1)
            refreshButton.Text = "🔄 Refresh Database"
            refreshButton.TextColor3 = THEME.Text
        end)
        
        -- Theme Settings Button
        local themeFrame = new("Frame", {
            Name = "ThemeFrame",
            Size = UDim2.new(1, 0, 0, 50),
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BorderSizePixel = 0,
            LayoutOrder = 3,
            ZIndex = 1000005
        })
        themeFrame.Parent = ScrollFrame
        
        local themeCorner = new("UICorner")
        themeCorner.CornerRadius = UDim.new(0, 8)
        themeCorner.Parent = themeFrame
        
        local themeButton = new("TextButton", {
            Name = "ThemeButton",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "🎨 Theme Settings",
            Font = Enum.Font.GothamSemibold,
            TextSize = 14,
            TextColor3 = THEME.Text,
            AutoButtonColor = false,
            ZIndex = 1000006
        })
        themeButton.Parent = themeFrame
        
        themeButton.MouseButton1Click:Connect(function()
            themeButton.Text = "🎨 Coming Soon!"
            themeButton.TextColor3 = Window._accent
            NotificationSystem:CreateNotification("Coming Soon", "Theme customization will be available in future updates", "info")
            task.wait(1)
            themeButton.Text = "🎨 Theme Settings"
            themeButton.TextColor3 = THEME.Text
        end)
    end

    -- FIXED: Embedded script database with proper RequiresKey detection
    local SCRIPT_DATABASE = {
        [301549746] = { -- Counter Blox
            gameName = "Counter Blox",
            scripts = {
                {title = "Lynk CB", description = "Advanced Counter Blox script", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/vvisuall/lynkcb/refs/heads/main/counterblox"))()', RequiresKey = true}
            }
        },
        [9791603388] = { -- Underground War 2.0
            gameName = "Underground War 2.0",
            scripts = {
                {title = "Silent Aim Fixed", description = "Silent aim for Underground War", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/vvisuall/WITHERCC/refs/heads/main/un"))()', RequiresKey = false}
            }
        },
        ["Universal"] = {
            gameName = "Universal Scripts",
            scripts = {
                {title = "Infinite Yield", description = "Admin commands for any game", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()', RequiresKey = false},
                {title = "Fly Script", description = "Universal fly with speed control", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/vvisuall/lynkUI/refs/heads/main/fly.lua"))()', RequiresKey = false},
                {title = "Noclip", description = "Walk through walls", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/vvisuall/lynkUI/refs/heads/main/noclip.lua"))()', RequiresKey = false},
                {title = "Universal Fly", description = "Universal fly script", LoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/vvisuall/WITHERCC/refs/heads/main/universal%20fly"))()', RequiresKey = false}
            }
        }
    }

    local function getCurrentPlaceId()
        return game.PlaceId
    end

    -- Script sidebar system
    function Window:CreateScriptSidebar()
        -- Sidebar container (initially hidden off-screen)
        local ScriptSidebar = new("Frame", {
            Name = "ScriptSidebar",
            Position = UDim2.new(1, 0, 0, 0),
            Size = UDim2.new(0, 350, 1, 0),
            BackgroundColor3 = THEME.Surface,
            BorderSizePixel = 0,
            ZIndex = 1000100
        })
        ScriptSidebar.Parent = MainFrame
        
        local sidebarCorner = new("UICorner")
        sidebarCorner.CornerRadius = THEME.CornerRadius
        sidebarCorner.Parent = ScriptSidebar
        
        -- Sidebar gradient
        createGradient(ScriptSidebar, {
            ColorSequenceKeypoint.new(0, THEME.Surface),
            ColorSequenceKeypoint.new(1, THEME.Panel)
        }, 90)

        -- Return button
        local ReturnButton = new("TextButton", {
            Name = "ReturnButton",
            Position = UDim2.new(0, 10, 0, 10),
            Size = UDim2.new(0, 80, 0, 35),
            BackgroundColor3 = THEME.Primary,
            BorderSizePixel = 0,
            Text = "← Return",
            Font = Enum.Font.GothamBold,
            TextSize = 14,
            TextColor3 = Color3.fromRGB(255, 255, 255),
            ZIndex = 1000101
        })
        ReturnButton.Parent = ScriptSidebar
        
        local returnCorner = new("UICorner")
        returnCorner.CornerRadius = UDim.new(0, 8)
        returnCorner.Parent = ReturnButton
        
        -- Content container
        local ContentContainer = new("ScrollingFrame", {
            Name = "ContentContainer",
            Position = UDim2.new(0, 20, 0, 60),
            Size = UDim2.new(1, -40, 1, -80),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 6,
            ScrollBarImageColor3 = THEME.Primary,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ZIndex = 1000101
        })
        ContentContainer.Parent = ScriptSidebar
        
        local contentLayout = new("UIListLayout")
        contentLayout.Parent = ContentContainer
        contentLayout.Padding = UDim.new(0, 15)
        contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        
        -- Store references
        Window._scriptSidebar = ScriptSidebar
        Window._sidebarContent = ContentContainer
        Window._sidebarReturnButton = ReturnButton
        
        -- Return button functionality
        ReturnButton.MouseButton1Click:Connect(function()
            Window:CloseScriptSidebar()
        end)
        
        return ScriptSidebar
    end

    function Window:OpenScriptSidebar(gameData, script)
        if not Window._scriptSidebar then
            Window:CreateScriptSidebar()
        end
        
        -- Make sidebar visible again when opening
        Window._scriptSidebar.Visible = true
        
        -- Clear existing content
        for _, child in pairs(Window._sidebarContent:GetChildren()) do
            if child:IsA("GuiObject") then
                child:Destroy()
            end
        end
        
        local placeId = gameData.placeId or "Universal"
        
        -- Game thumbnail (larger version)
        local ThumbnailContainer = new("Frame", {
            Name = "SidebarThumbnail",
            Size = UDim2.new(1, 0, 0, 180),
            BackgroundColor3 = THEME.Card,
            BorderSizePixel = 0,
            LayoutOrder = 1,
            ZIndex = 1000102
        })
        ThumbnailContainer.Parent = Window._sidebarContent
        
        local thumbCorner = new("UICorner")
        thumbCorner.CornerRadius = THEME.SmallCornerRadius
        thumbCorner.Parent = ThumbnailContainer
        
        local GameThumbnail = new("ImageLabel", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Image = placeId ~= "Universal" and string.format("https://www.roblox.com/asset-thumbnail/image?assetId=%d&width=768&height=432&format=png", placeId) or "rbxassetid://83202805728510",
            ScaleType = Enum.ScaleType.Crop,
            ZIndex = 1000102
        })
        GameThumbnail.Parent = ThumbnailContainer
        
        local imageCorner = new("UICorner")
        imageCorner.CornerRadius = THEME.SmallCornerRadius
        imageCorner.Parent = GameThumbnail
        
        -- FIXED: Key indicator with proper boolean detection
        if script.RequiresKey == true then
            local KeyIndicator = new("Frame", {
                Position = UDim2.new(1, -35, 0, 10),
                Size = UDim2.new(0, 25, 0, 25),
                BackgroundColor3 = Color3.fromRGB(255, 193, 7),
                BorderSizePixel = 0,
                ZIndex = 1000103
            })
            KeyIndicator.Parent = ThumbnailContainer
            
            local keyCorner = new("UICorner")
            keyCorner.CornerRadius = UDim.new(0.5, 0)
            keyCorner.Parent = KeyIndicator
            
            local KeyIcon = new("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = "🔑",
                Font = Enum.Font.GothamBold,
                TextSize = 14,
                TextColor3 = Color3.fromRGB(0, 0, 0),
                TextXAlignment = Enum.TextXAlignment.Center,
                TextYAlignment = Enum.TextYAlignment.Center,
                ZIndex = 1000103
            })
            KeyIcon.Parent = KeyIndicator
        end
        
        -- Game name
        local GameNameLabel = new("TextLabel", {
            Name = "SidebarGameName",
            Size = UDim2.new(1, 0, 0, 20),
            BackgroundTransparency = 1,
            Text = gameData.gameName,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextColor3 = THEME.TextMuted,
            TextXAlignment = Enum.TextXAlignment.Left,
            LayoutOrder = 2,
            ZIndex = 1000102
        })
        GameNameLabel.Parent = Window._sidebarContent
        
        -- Script name (large and bold)
        local ScriptNameLabel = new("TextLabel", {
            Name = "SidebarScriptName",
            Size = UDim2.new(1, 0, 0, 30),
            BackgroundTransparency = 1,
            Text = script.Title or script.title or "Unknown Script",
            Font = Enum.Font.GothamBold,
            TextSize = 20,
            TextColor3 = THEME.Text,
            TextXAlignment = Enum.TextXAlignment.Left,
            LayoutOrder = 3,
            ZIndex = 1000102
        })
        ScriptNameLabel.Parent = Window._sidebarContent
        
        -- Description (if available)
        if script.Description or script.description then
            local DescriptionLabel = new("TextLabel", {
                Name = "SidebarDescription",
                Size = UDim2.new(1, 0, 0, 0),
                BackgroundTransparency = 1,
                Text = script.Description or script.description,
                Font = Enum.Font.Gotham,
                TextSize = 13,
                TextColor3 = THEME.TextMuted,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextYAlignment = Enum.TextYAlignment.Top,
                TextWrapped = true,
                AutomaticSize = Enum.AutomaticSize.Y,
                LayoutOrder = 4,
                ZIndex = 1000102
            })
            DescriptionLabel.Parent = Window._sidebarContent
        end
        
        -- Execute button (large and prominent)
        local ExecuteButton = new("TextButton", {
            Name = "SidebarExecuteButton",
            Size = UDim2.new(1, 0, 0, 50),
            BackgroundColor3 = Color3.fromRGB(34, 197, 94),
            BorderSizePixel = 0,
            Text = "Execute Script",
            Font = Enum.Font.GothamBold,
            TextSize = 16,
            TextColor3 = Color3.fromRGB(255, 255, 255),
            AutoButtonColor = false,
            LayoutOrder = 5,
            ZIndex = 1000102
        })
        ExecuteButton.Parent = Window._sidebarContent
        
        local executeCorner = new("UICorner")
        executeCorner.CornerRadius = THEME.SmallCornerRadius
        executeCorner.Parent = ExecuteButton
        
        -- Execute button functionality
        ExecuteButton.MouseButton1Click:Connect(function()
            ExecuteButton.Text = "Executing..."
            ExecuteButton.BackgroundColor3 = THEME.TextMuted
            
            spawn(function()
                local success, result = pcall(function()
                    if script.url then
                        loadstring(game:HttpGet(script.url))()
                    elseif script.LoadString then
                        loadstring(script.LoadString)()
                    else
                        error("No valid script entry found (url or LoadString missing)")
                    end
                end)
                
                wait(1)
                
                if success then
                    ExecuteButton.Text = "Executed Successfully ✓"
                    ExecuteButton.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
                    NotificationSystem:CreateNotification("Script Executed", script.title .. " executed successfully", "success")
                else
                    ExecuteButton.Text = "Execution Failed ✗"
                    ExecuteButton.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
                    NotificationSystem:CreateNotification("Execution Failed", "Script failed to execute: " .. tostring(result), "error")
                    warn("❌ Script execution failed:", result)
                end
                
                wait(3)
                ExecuteButton.Text = "Execute Script"
                ExecuteButton.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
            end)
        end)
        
        -- Animate sidebar in
        TweenService:Create(Window._scriptSidebar, THEME.MediumTween, {
            Position = UDim2.new(1, -350, 0, 0)
        }):Play()
    end

    function Window:CloseScriptSidebar()
        if Window._scriptSidebar then
            -- Hide sidebar completely instead of moving to side
            local closeTween = TweenService:Create(Window._scriptSidebar, THEME.MediumTween, {
                Position = UDim2.new(1, 0, 0, 0),
                Visible = false
            })
            closeTween:Play()
            
            -- Clear sidebar content after animation
            closeTween.Completed:Connect(function()
                if Window._sidebarContent then
                    for _, child in pairs(Window._sidebarContent:GetChildren()) do
                        if child:IsA("GuiObject") then
                            child:Destroy()
                        end
                    end
                end
            end)
        end
    end

    -- FIXED: Script card creation with proper key symbol detection
    local function createScriptCard(parent, gameData, script, position)
        local placeId = gameData.placeId or "Universal"
        
        -- Card container
        local Card = new("Frame", {
            Name = "ScriptCard",
            Size = UDim2.new(0, 240, 0, 180),
            BackgroundColor3 = THEME.Card,
            BorderSizePixel = 0,
            ZIndex = 1000004
        })
        Card.Parent = parent
        
        local cardCorner = new("UICorner")
        cardCorner.CornerRadius = THEME.SmallCornerRadius
        cardCorner.Parent = Card
        
        -- Card shadow/glow effect
        createGlow(Card, THEME.Primary, 0.8)
        
        -- Game thumbnail
        local ThumbnailContainer = new("Frame", {
            Name = "ThumbnailContainer",
            Position = UDim2.new(0, 8, 0, 8),
            Size = UDim2.new(1, -16, 0, 120),
            BackgroundColor3 = THEME.Surface,
            BorderSizePixel = 0,
            ZIndex = 1000005
        })
        ThumbnailContainer.Parent = Card
        
        local thumbCorner = new("UICorner")
        thumbCorner.CornerRadius = THEME.SmallCornerRadius
        thumbCorner.Parent = ThumbnailContainer
        
        -- Game thumbnail image
        local GameThumbnail = new("ImageLabel", {
            Name = "GameThumbnail",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Image = placeId ~= "Universal" and string.format("https://www.roblox.com/asset-thumbnail/image?assetId=%d&width=768&height=432&format=png", placeId) or "rbxassetid://83202805728510",
            ScaleType = Enum.ScaleType.Crop,
            ZIndex = 1000005
        })
        GameThumbnail.Parent = ThumbnailContainer
        
        local imageCorner = new("UICorner")
        imageCorner.CornerRadius = THEME.SmallCornerRadius
        imageCorner.Parent = GameThumbnail
        
        -- FIXED: Key system indicator with proper boolean detection
        if script.RequiresKey == true then
            local KeyIndicator = new("Frame", {
                Name = "KeyIndicator",
                Position = UDim2.new(1, -30, 0, 8),
                Size = UDim2.new(0, 22, 0, 22),
                BackgroundColor3 = Color3.fromRGB(255, 193, 7),
                BorderSizePixel = 0,
                ZIndex = 1000006
            })
            KeyIndicator.Parent = ThumbnailContainer
            
            local keyCorner = new("UICorner")
            keyCorner.CornerRadius = UDim.new(0.5, 0)
            keyCorner.Parent = KeyIndicator
            
            local KeyIcon = new("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = "🔑",
                Font = Enum.Font.GothamBold,
                TextSize = 12,
                TextColor3 = Color3.fromRGB(0, 0, 0),
                TextXAlignment = Enum.TextXAlignment.Center,
                TextYAlignment = Enum.TextYAlignment.Center,
                ZIndex = 1000006
            })
            KeyIcon.Parent = KeyIndicator
        end
        
        -- Game name
        local GameName = new("TextLabel", {
            Name = "GameName",
            Position = UDim2.new(0, 12, 0, 135),
            Size = UDim2.new(1, -24, 0, 16),
            BackgroundTransparency = 1,
            Text = gameData.gameName,
            Font = Enum.Font.Gotham,
            TextSize = 12,
            TextColor3 = THEME.TextMuted,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            ZIndex = 1000005
        })
        GameName.Parent = Card
        
        -- Script name (bigger and bolder)
        local ScriptName = new("TextLabel", {
            Name = "ScriptName",
            Position = UDim2.new(0, 12, 0, 152),
            Size = UDim2.new(1, -24, 0, 20),
            BackgroundTransparency = 1,
            Text = script.Title or script.title,
            Font = Enum.Font.GothamBold,
            TextSize = 16,
            TextColor3 = THEME.Text,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            ZIndex = 1000005
        })
        ScriptName.Parent = Card
        
        -- Click handler to open sidebar
        local ClickButton = new("TextButton", {
            Name = "ClickButton",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "",
            ZIndex = 1000010
        })
        ClickButton.Parent = Card
        
        -- Card click functionality to open sidebar
        ClickButton.MouseButton1Click:Connect(function()
            Window:OpenScriptSidebar(gameData, script)
        end)
        
        -- Hover effects
        ClickButton.MouseEnter:Connect(function()
            TweenService:Create(Card, THEME.FastTween, {
                BackgroundColor3 = THEME.Surface
            }):Play()
        end)
        
        ClickButton.MouseLeave:Connect(function()
            TweenService:Create(Card, THEME.FastTween, {
                BackgroundColor3 = THEME.Card
            }):Play()
        end)
        
        return Card
    end

    -- FIXED: Populate home tab with script cards
    local function populateHomeTab(homeTab)
        -- Clear existing content
        for _, child in pairs(homeTab:GetChildren()) do
            if child:IsA("GuiObject") then
                child:Destroy()
            end
        end
        
        -- Create search bar
        local searchFrame = new("Frame", {
            Name = "SearchFrame",
            Position = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(1, 0, 0, 40),
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BorderSizePixel = 0,
            ZIndex = 1000004
        })
        searchFrame.Parent = homeTab
        
        local searchCorner = new("UICorner")
        searchCorner.CornerRadius = UDim.new(0, 8)
        searchCorner.Parent = searchFrame
        
        local searchBox = new("TextBox", {
            Name = "SearchBox",
            Position = UDim2.new(0, 15, 0, 0),
            Size = UDim2.new(1, -30, 1, 0),
            BackgroundTransparency = 1,
            Text = "",
            PlaceholderText = "🔍 Search scripts...",
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextColor3 = THEME.Text,
            PlaceholderColor3 = THEME.TextMuted,
            TextXAlignment = Enum.TextXAlignment.Left,
            ClearTextOnFocus = false,
            ZIndex = 1000005
        })
        searchBox.Parent = searchFrame
        
        -- Create scroll frame for script cards
        local ScrollFrame = new("ScrollingFrame", {
            Name = "ScriptScrollFrame",
            Position = UDim2.new(0, 0, 0, 50),
            Size = UDim2.new(1, 0, 1, -50),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 6,
            ScrollBarImageColor3 = THEME.Primary,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ZIndex = 1000004
        })
        ScrollFrame.Parent = homeTab
        
        -- Add search functionality
        searchBox.Changed:Connect(function(property)
            if property == "Text" then
                local searchText = searchBox.Text
                
                for _, card in pairs(ScrollFrame:GetChildren()) do
                    if card:IsA("Frame") and card.Name ~= "UIGridLayout" and card.Name ~= "UIPadding" then
                        local scriptNameLabel = card:FindFirstChild("ScriptName")
                        local gameNameLabel = card:FindFirstChild("GameName")
                        local visible = false
                        
                        if searchText == "" then
                            visible = true
                        else
                            local searchLower = searchText:lower()
                            
                            if scriptNameLabel and scriptNameLabel.Text:lower():find(searchLower) then
                                visible = true
                            end
                            
                            if gameNameLabel and gameNameLabel.Text:lower():find(searchLower) then
                                visible = true
                            end
                            
                            local keywords = card:GetAttribute("Keywords") or ""
                            if keywords:lower():find(searchLower) then
                                visible = true
                            end
                            
                            local description = card:GetAttribute("Description") or ""
                            if description:lower():find(searchLower) then
                                visible = true
                            end
                        end
                        
                        card.Visible = visible
                    end
                end
            end
        end)
        
        -- Grid layout for 2-column display
        wait()
        local actualWidth = ScrollFrame.AbsoluteSize.X > 0 and ScrollFrame.AbsoluteSize.X or 580
        local totalPadding = 30
        local cellWidth = math.floor((actualWidth - totalPadding) / 2)
        cellWidth = math.max(cellWidth, 220)
        
        local GridLayout = new("UIGridLayout", {
            CellSize = UDim2.new(0, cellWidth, 0, 180),
            CellPadding = UDim2.new(0, 10, 0, 15),
            HorizontalAlignment = Enum.HorizontalAlignment.Left,
            VerticalAlignment = Enum.VerticalAlignment.Top,
            SortOrder = Enum.SortOrder.LayoutOrder,
            FillDirection = Enum.FillDirection.Horizontal,
            StartCorner = Enum.StartCorner.TopLeft
        })
        GridLayout.Parent = ScrollFrame
        
        -- Add padding to scroll frame
        local Padding = new("UIPadding", {
            PaddingTop = UDim.new(0, 15),
            PaddingBottom = UDim.new(0, 15),
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10)
        })
        Padding.Parent = ScrollFrame

        -- Get current game's scripts
        local currentPlaceId = getCurrentPlaceId()
        local currentGameData = DB()[currentPlaceId]
        
        local cardIndex = 0
        
        -- Add current game's scripts first (if available)
        if currentGameData then
            for _, script in pairs(currentGameData.scripts) do
                local card = createScriptCard(ScrollFrame, {
                    placeId = currentPlaceId,
                    gameName = currentGameData.gameName
                }, script)
                card.LayoutOrder = cardIndex
                card:SetAttribute("Keywords", script.keywords or "")
                card:SetAttribute("Description", script.description or "")
                cardIndex = cardIndex + 1
            end
        end
        
        -- Add universal scripts
        local universalData = DB()["Universal"]
        if universalData then
            for _, script in pairs(universalData.scripts) do
                local card = createScriptCard(ScrollFrame, {
                    placeId = "Universal",
                    gameName = universalData.gameName
                }, script)
                card.LayoutOrder = cardIndex
                card:SetAttribute("Keywords", script.keywords or "fly noclip speed universal movement")
                card:SetAttribute("Description", script.description or "")
                cardIndex = cardIndex + 1
            end
        end
        
        -- Add other games' scripts
        for placeId, gameData in pairs(DB()) do
            if placeId ~= currentPlaceId and placeId ~= "Universal" then
                for _, script in pairs(gameData.scripts) do
                    local card = createScriptCard(ScrollFrame, {
                        placeId = placeId,
                        gameName = gameData.gameName
                    }, script)
                    card.LayoutOrder = cardIndex
                    card:SetAttribute("Keywords", script.keywords or "")
                    card:SetAttribute("Description", script.description or "")
                    cardIndex = cardIndex + 1
                end
            end
        end
    end

    -- FIXED: LoadScriptCards to populate all tabs and ensure Home shows first
    function Window:LoadScriptCards()
        -- Only create tabs if none exist yet
        if #Window._tabs == 0 then
            -- Create tabs with your specified icons and order
            local homeTab = Window:CreateTab("Home", "rbxassetid://10734950309", 1)
            local updatesTab = Window:CreateTab("Updates", "rbxassetid://7733674079", 2)
            local creditsTab = Window:CreateTab("Credits", "rbxassetid://7733955511", 3)
            local settingsTab = Window:CreateTab("Settings", "rbxassetid://10734950020", 4)

            -- Populate all tabs
            populateHomeTab(homeTab.Page)
            populateUpdatesTab(updatesTab.Page)
            populateCreditsTab(creditsTab.Page)
            populateSettingsTab(settingsTab.Page)

            -- FIXED: Ensure home tab shows first with delay
            spawn(function()
                wait(0.1)
                homeTab:Show()
            end)
        end
    end

    function Window:Destroy()
        NotificationSystem:Cleanup()
        if screen and screen.Parent then
            screen:Destroy()
        end
    end

    -- FIXED: Start hidden by default; show key screen or hub based on lock state
    setVisibility(false)

    if Window._locked then
        -- Show key system; main hub stays hidden until unlocked
        createKeySystem(Window)
    else
        -- No key system; show hub immediately
        Window:Show()
    end

    -- FIXED: Always apply metatable regardless of key system state
    setmetatable(Window, {__index = Lynk})

    return Window
end

return Lynk
